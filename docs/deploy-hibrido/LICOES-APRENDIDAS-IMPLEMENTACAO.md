# üéì Li√ß√µes Aprendidas - Implementa√ß√£o Deploy H√≠brido API

> **Data da Implementa√ß√£o:** 16 de Outubro de 2025
> **Projeto:** Sistema de Gest√£o de Chamados - API FastAPI
> **Status:** ‚úÖ Funcionando em Produ√ß√£o

Este documento registra todas as corre√ß√µes, problemas encontrados e solu√ß√µes aplicadas durante a implementa√ß√£o real do deploy h√≠brido para a API.

## üìã √çndice

1. [Resumo Executivo](#resumo-executivo)
2. [Problemas Encontrados e Solu√ß√µes](#problemas-encontrados-e-solu√ß√µes)
3. [Configura√ß√µes Cr√≠ticas](#configura√ß√µes-cr√≠ticas)
4. [Checklist de Valida√ß√£o](#checklist-de-valida√ß√£o)
5. [Comandos de Troubleshooting](#comandos-de-troubleshooting)

---

## üéØ Resumo Executivo

### ‚úÖ O Que Funcionou

**Deploy H√≠brido 100% Funcional:**
- ‚úÖ Acesso direto: `http://10.0.20.11:8002/api/v1/*`
- ‚úÖ Acesso via proxy HTTP: `http://office.inoveon.com.br/api/suporte/v1/*`
- ‚úÖ Acesso via proxy HTTPS: `https://office.inoveon.com.br/api/suporte/v1/*`

**Transforma√ß√£o de Paths pelo Traefik:**
```
Cliente ‚Üí https://office.inoveon.com.br/api/suporte/v1/auth/login
   ‚Üì Traefik StripPrefix
     /v1/auth/login
   ‚Üì Traefik AddPrefix
     /api/v1/auth/login
   ‚Üì FastAPI processa
     ‚úÖ 200 OK - Token JWT retornado
```

### üîß Corre√ß√µes Necess√°rias (7 no total)

1. **Senha do banco de dados** - DATABASE_URL_ASYNC com senha diferente
2. **Host do banco** - Usar IP `10.0.20.11` em vez de nome do container
3. **FastAPI root_path** - Remover completamente (causava duplica√ß√£o de paths)
4. **Health check SQL** - Usar `text()` para evitar warnings SQLAlchemy
5. **TrustedHostMiddleware** - Desabilitar para permitir IPs internos Docker
6. **Traefik network** - For√ßar uso da rede correta com label expl√≠cita
7. **Seed do banco** - Popular banco com dados iniciais ap√≥s deploy

---

## üêõ Problemas Encontrados e Solu√ß√µes

### 1. ‚ùå Erro: Database Connection Loop Infinito

**Sintoma:**
```bash
Container suporte-api travado em loop:
"‚è≥ Aguardando banco de dados..."
"Tentativa 1/30: Banco n√£o dispon√≠vel, aguardando..."
```

**Causa Raiz:**
O `entrypoint.sh` tinha senha hardcoded diferente da senha real do banco.

**Solu√ß√£o:**
```dockerfile
# ‚ùå ERRADO - Hardcoded
until python -c "import psycopg2; psycopg2.connect('postgresql://user:SENHA_ERRADA@host:5432/db')" 2>/dev/null; do

# ‚úÖ CORRETO - Usar vari√°vel de ambiente
until python -c "import psycopg2; psycopg2.connect('$DATABASE_URL')" 2>/dev/null; do
```

**Arquivo:** `api/deploy/Dockerfile.prod`
**Commit:** `fix(deploy): corrige entrypoint.sh para usar DATABASE_URL do ambiente`

---

### 2. ‚ùå Erro: Password Authentication Failed

**Sintoma:**
```
asyncpg.exceptions.InvalidPasswordError: password authentication failed for user "suporte_user"
```

**Causa Raiz:**
Duas vari√°veis de ambiente com senhas diferentes:
- `DATABASE_URL`: `XLgurNArM2FQTVbOyqyTCEEt0FUtaYF5` ‚úÖ
- `DATABASE_URL_ASYNC`: `0yXi9oW7KXPJJV17Ohybdn3X0Qgchuij` ‚ùå

**Solu√ß√£o:**
```bash
# Atualizar .env com mesma senha em ambas
DATABASE_URL=postgresql://suporte_user:XLgurNArM2FQTVbOyqyTCEEt0FUtaYF5@10.0.20.11:5432/suporte_db
DATABASE_URL_ASYNC=postgresql+asyncpg://suporte_user:XLgurNArM2FQTVbOyqyTCEEt0FUtaYF5@10.0.20.11:5432/suporte_db

# Recriar container (restart n√£o recarrega .env!)
docker-compose up -d suporte-api
```

**Arquivo:** `api/deploy/.env`
**Commit:** `fix(api): corrige autentica√ß√£o e duplica√ß√£o de paths`

**‚ö†Ô∏è IMPORTANTE:** `docker restart` N√ÉO recarrega vari√°veis de ambiente! Use `docker-compose up -d` para for√ßar recria√ß√£o.

---

### 3. ‚ùå Erro: Path Duplication (404 Not Found)

**Sintoma:**
```bash
# Request do cliente
POST https://office.inoveon.com.br/api/suporte/v1/auth/login

# Log do servidor mostra path duplicado
POST /api/suporte/api/v1/auth/login returned 404
```

**Causa Raiz:**
FastAPI configurado com `root_path="/api/suporte"` estava **preenchendo** todas as rotas com esse prefixo, duplicando o path ap√≥s o AddPrefix do Traefik.

**Solu√ß√£o:**
```python
# ‚ùå ERRADO - Duplica paths
app = FastAPI(
    title=settings.PROJECT_NAME,
    root_path="/api/suporte",  # ‚Üê Remove isso!
)

# ‚úÖ CORRETO - S√≥ servers para documenta√ß√£o OpenAPI
app = FastAPI(
    title=settings.PROJECT_NAME,
    # root_path removido
    servers=[
        {"url": "/api/suporte", "description": "Produ√ß√£o (via Traefik proxy)"},
        {"url": "http://10.0.20.11:8002/api", "description": "Desenvolvimento (acesso direto)"},
    ],
)
```

**Arquivo:** `api/suporte_chamados_api_fastapi/app/main.py`
**Linha:** 76-85
**Commit:** `fix(api): corrige autentica√ß√£o e duplica√ß√£o de paths`

**üìö Aprendizado:**
- `root_path` ‚Üí Modifica paths **reais** das rotas (afeta routing)
- `servers` ‚Üí Apenas documenta√ß√£o OpenAPI (n√£o afeta routing)

---

### 4. ‚ùå Erro: Health Check SQL Warning

**Sintoma:**
```json
{
  "status": "degraded",
  "checks": {
    "database": "unhealthy: Textual SQL expression 'SELECT 1' should be explicitly declared as text('SELECT 1')"
  }
}
```

**Causa Raiz:**
SQLAlchemy 2.0+ requer que queries SQL textuais sejam envolvidas em `text()`.

**Solu√ß√£o:**
```python
# ‚ùå ERRADO
from app.core.database import AsyncSessionLocal
async with AsyncSessionLocal() as db:
    await db.execute("SELECT 1")

# ‚úÖ CORRETO
from app.core.database import AsyncSessionLocal
from sqlalchemy import text
async with AsyncSessionLocal() as db:
    await db.execute(text("SELECT 1"))
```

**Arquivo:** `api/suporte_chamados_api_fastapi/app/core/monitoring.py`
**Linha:** 300-306
**Commit:** `fix(monitoring): corrige query SQL no health check`

---

### 5. ‚ùå Erro: Traefik Health Check Returns 400 Bad Request

**Sintoma:**
```bash
# Traefik tentando fazer health check
wget http://172.21.0.3:8002/health
# Resposta: HTTP/1.1 400 Bad Request

# Service marcado como DOWN no Traefik
"serverStatus": {
  "http://172.21.0.3:8002": "DOWN"
}
```

**Causa Raiz:**
`TrustedHostMiddleware` do FastAPI rejeitando requests com Host header de IPs internos Docker (`172.x.x.x`).

**Solu√ß√£o:**
```python
# ‚ùå ERRADO - Bloqueia IPs internos Docker
if not settings.DEBUG:
    app.add_middleware(
        TrustedHostMiddleware,
        allowed_hosts=["localhost", "127.0.0.1", "10.0.20.11", "office.inoveon.com.br"],
    )

# ‚úÖ CORRETO - Desabilitar temporariamente
# NOTA: Comentado para permitir healthchecks do Traefik via IPs internos
# if not settings.DEBUG:
#     app.add_middleware(
#         TrustedHostMiddleware,
#         allowed_hosts=["localhost", "127.0.0.1", "10.0.20.11", "office.inoveon.com.br"],
#     )
```

**Arquivo:** `api/suporte_chamados_api_fastapi/app/main.py`
**Linha:** 120-126
**Commit:** `fix(middleware): desabilita TrustedHostMiddleware para permitir health checks`

**üìö Aprendizado:**
- Traefik faz health check usando IP interno da rede Docker
- TrustedHostMiddleware deve incluir IPs internos OU ser desabilitado
- Alternativa: Configurar wildcard `allowed_hosts=["*"]` em produ√ß√£o (menos seguro)

---

### 6. ‚ùå Erro: Traefik Usando IP Errado da Rede

**Sintoma:**
```bash
# Container tem 3 IPs em 3 redes diferentes
traefik_net:       172.21.0.3  ‚úÖ (correta)
suporte_internal:  172.23.0.3  ‚ùå (Traefik estava usando)
database_net:      172.22.0.3  ‚ùå

# Traefik reportando servidor DOWN no IP errado
"serverStatus": {
  "http://172.23.0.3:8002": "DOWN"
}
```

**Causa Raiz:**
Container conectado em m√∫ltiplas redes Docker. Traefik escolhe automaticamente a primeira rede que encontra, que nem sempre √© a `traefik_net`.

**Solu√ß√£o:**
```yaml
# docker-compose.prod.yml
services:
  suporte-api:
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_net  # ‚Üê For√ßa uso desta rede
      # ... outras labels
    networks:
      - traefik_net
      - suporte_internal
      - database_net
```

**Arquivo:** `deploy/docker-compose.prod.yml`
**Linha:** 30
**Commit:** `fix(deploy): for√ßa Traefik a usar rede traefik_net`

**üìö Aprendizado:**
- **SEMPRE** adicionar `traefik.docker.network` quando container est√° em m√∫ltiplas redes
- Traefik n√£o escolhe automaticamente a rede correta
- Ap√≥s adicionar label, RECRIAR container (restart n√£o basta)

---

### 7. ‚ùå Erro: Banco de Dados Vazio Ap√≥s Deploy

**Sintoma:**
```bash
curl -X POST http://10.0.20.11:8002/api/v1/auth/login \
  -d '{"email":"lee@inoveon.com.br","password":"admin123"}'
# Resposta: {"detail":"Incorrect email or password"}

# Verificando banco
SELECT COUNT(*) FROM usuarios;
# Resultado: 0 rows
```

**Causa Raiz:**
Deploy inicial com banco zerado. Migrations criam tabelas mas n√£o populam dados.

**Solu√ß√£o:**
```bash
# Executar script de seed via container
docker exec suporte-api python scripts/database/seed_database.py

# Sa√≠da esperada:
# ‚úÖ 9 usu√°rios criados com cargos e departamentos
# ‚úÖ Grupo Aldo criado com 7 filiais e 7 sistemas
# ‚úÖ 4 configura√ß√µes SLA criadas
```

**Script:** `api/suporte_chamados_api_fastapi/scripts/database/seed_database.py`
**Credenciais Criadas:**
- lee@inoveon.com.br / admin123 (Diretor)
- diego@inoveon.com.br / admin123 (Diretor)
- moral@inoveon.com.br / dev123 (Desenvolvedor)

**üìö Aprendizado:**
- Migrations ‚â† Seed de dados
- Criar script de seed separado e documentar
- Incluir seed no processo de deploy automatizado

---

## ‚öôÔ∏è Configura√ß√µes Cr√≠ticas

### 1. FastAPI - main.py

```python
# app/main.py

# ‚úÖ N√ÉO usar root_path (causa duplica√ß√£o)
# ‚ùå root_path="/api/suporte"

# ‚úÖ Usar apenas servers para documenta√ß√£o
app = FastAPI(
    title=settings.PROJECT_NAME,
    description=settings.DESCRIPTION,
    version=settings.VERSION,
    servers=[
        {"url": "/api/suporte", "description": "Produ√ß√£o (via Traefik proxy)"},
        {"url": "http://10.0.20.11:8002/api", "description": "Desenvolvimento (acesso direto)"},
    ],
)

# ‚úÖ TrustedHostMiddleware desabilitado
# (ou incluir IPs internos: 172.0.0.0/8)
```

### 2. Traefik - docker-compose.prod.yml

```yaml
services:
  suporte-api:
    ports:
      - "8002:8002"  # ‚úÖ Expor para acesso direto

    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_net  # ‚úÖ CR√çTICO!

      # Routers
      - traefik.http.routers.suporte-api.rule=Host(`office.inoveon.com.br`) && PathPrefix(`/api/suporte`)
      - traefik.http.routers.suporte-api.entrypoints=websecure
      - traefik.http.routers.suporte-api.tls.certresolver=letsencrypt
      - traefik.http.routers.suporte-api.middlewares=suporte-api-transform@docker

      # Middlewares - Chain StripPrefix + AddPrefix
      - traefik.http.middlewares.suporte-api-strip.stripprefix.prefixes=/api/suporte
      - traefik.http.middlewares.suporte-api-add.addprefix.prefix=/api
      - traefik.http.middlewares.suporte-api-transform.chain.middlewares=suporte-api-strip,suporte-api-add

      # Service
      - traefik.http.services.suporte-api.loadbalancer.server.port=8002

      # Health Check (path AP√ìS transforma√ß√£o)
      - traefik.http.services.suporte-api.loadbalancer.healthcheck.path=/health
      - traefik.http.services.suporte-api.loadbalancer.healthcheck.interval=30s

    networks:
      - traefik_net     # ‚úÖ Primeira na lista
      - suporte_internal
      - database_net
```

### 3. Environment Variables (.env)

```bash
# ‚úÖ Mesma senha em ambas as URLs
DATABASE_URL=postgresql://suporte_user:MESMA_SENHA@10.0.20.11:5432/suporte_db
DATABASE_URL_ASYNC=postgresql+asyncpg://suporte_user:MESMA_SENHA@10.0.20.11:5432/suporte_db

# ‚úÖ Usar IP do host, n√£o nome do container
# ‚ùå @postgres-shared:5432
# ‚úÖ @10.0.20.11:5432

REDIS_URL=redis://suporte-redis:6379/0
SECRET_KEY=sua-chave-forte-aqui
ENVIRONMENT=production
DEBUG=false
```

### 4. Dockerfile - entrypoint.sh

```dockerfile
# ‚úÖ Usar vari√°vel de ambiente, n√£o hardcode
COPY --chown=app:app <<'EOF' /app/entrypoint.sh
#!/bin/bash
set -e

echo "‚è≥ Aguardando banco de dados..."
until python -c "import psycopg2; psycopg2.connect('$DATABASE_URL')" 2>/dev/null; do
    echo "Banco n√£o dispon√≠vel, aguardando..."
    sleep 2
done
echo "‚úÖ Banco de dados pronto!"

alembic upgrade head
exec uvicorn app.main:app --host 0.0.0.0 --port 8002
EOF
```

---

## ‚úÖ Checklist de Valida√ß√£o

Use este checklist ap√≥s cada deploy:

### Antes do Deploy

- [ ] `.env` com senhas id√™nticas em `DATABASE_URL` e `DATABASE_URL_ASYNC`
- [ ] `.env` usando IP do host do banco (`10.0.20.11`), n√£o nome do container
- [ ] `docker-compose.prod.yml` com label `traefik.docker.network=traefik_net`
- [ ] FastAPI **SEM** `root_path` no c√≥digo
- [ ] `TrustedHostMiddleware` desabilitado ou com IPs internos
- [ ] Health check usando `text("SELECT 1")`
- [ ] Portas expostas no docker-compose (8002 para API, 3002 para Portal)

### Ap√≥s o Deploy

- [ ] Container iniciou e est√° healthy: `docker ps | grep suporte-api`
- [ ] Health check interno OK: `curl http://10.0.20.11:8002/health`
- [ ] Traefik vendo servidor UP: `curl http://10.0.20.11:8080/api/http/services | jq`
- [ ] Login direto funciona: `curl -X POST http://10.0.20.11:8002/api/v1/auth/login`
- [ ] Login via proxy HTTP: `curl -X POST http://office.inoveon.com.br/api/suporte/v1/auth/login`
- [ ] Login via proxy HTTPS: `curl -X POST https://office.inoveon.com.br/api/suporte/v1/auth/login`
- [ ] Swagger acess√≠vel: `https://office.inoveon.com.br/api/suporte/docs`
- [ ] Banco populado: `docker exec suporte-api python scripts/database/seed_database.py`

### Testes de Integra√ß√£o

```bash
# 1. Testar acesso direto (desenvolvimento)
curl http://10.0.20.11:8002/health
# Esperado: {"status":"healthy",...}

# 2. Testar login direto
curl -X POST http://10.0.20.11:8002/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"lee@inoveon.com.br","password":"admin123"}'
# Esperado: {"access_token":"eyJ...","user":{...}}

# 3. Testar via proxy HTTPS
curl -X POST https://office.inoveon.com.br/api/suporte/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"lee@inoveon.com.br","password":"admin123"}' -k
# Esperado: {"access_token":"eyJ...","user":{...}}

# 4. Verificar Swagger
curl https://office.inoveon.com.br/api/suporte/docs -k | grep -i "swagger"
# Esperado: HTML do Swagger UI
```

---

## üîç Comandos de Troubleshooting

### Verificar Container

```bash
# Status do container
docker ps | grep suporte-api

# Logs em tempo real
docker logs suporte-api -f

# √öltimas 100 linhas
docker logs suporte-api --tail 100

# Apenas erros
docker logs suporte-api 2>&1 | grep -i error
```

### Verificar Traefik

```bash
# Ver todos os routers
curl -s http://10.0.20.11:8080/api/http/routers | jq '.[] | select(.name | contains("suporte"))'

# Ver todos os services e status
curl -s http://10.0.20.11:8080/api/http/services | jq '.[] | select(.name | contains("suporte"))'

# Ver middlewares
curl -s http://10.0.20.11:8080/api/http/middlewares | jq '.[] | select(.name | contains("suporte"))'

# Logs do Traefik
docker logs traefik --tail 50
```

### Verificar Redes Docker

```bash
# IPs do container em cada rede
docker inspect suporte-api -f "{{json .NetworkSettings.Networks}}" | jq '.'

# Qual IP o Traefik est√° usando
curl -s http://10.0.20.11:8080/api/http/services | jq '.[] | select(.name=="suporte-api@docker") | .loadBalancer.servers'
```

### Testar Health Check Como o Traefik Faz

```bash
# De dentro do container Traefik
docker exec traefik wget --timeout=5 -qO- http://172.21.0.3:8002/health

# De dentro do container da API
docker exec suporte-api curl -s http://127.0.0.1:8002/health
```

### Verificar Vari√°veis de Ambiente

```bash
# Ver todas as env vars do container
docker exec suporte-api env | grep DATABASE

# Verificar se .env foi carregado
docker inspect suporte-api -f '{{range .Config.Env}}{{println .}}{{end}}' | grep DATABASE
```

### For√ßar Recria√ß√£o Completa

```bash
# Parar, remover e recriar (recarrega .env)
cd /docker/inoveon/suporte
docker-compose -f docker-compose.prod.yml stop suporte-api
docker-compose -f docker-compose.prod.yml rm -f suporte-api
docker-compose -f docker-compose.prod.yml up -d suporte-api

# Rebuild sem cache
docker-compose -f docker-compose.prod.yml build --no-cache suporte-api
docker-compose -f docker-compose.prod.yml up -d suporte-api
```

### Verificar Banco de Dados

```bash
# Conectar ao banco via container
docker exec postgres-shared psql -U suporte_user -d suporte_db

# Contar usu√°rios
docker exec postgres-shared psql -U suporte_user -d suporte_db -c "SELECT COUNT(*) FROM usuarios;"

# Ver tabelas
docker exec postgres-shared psql -U suporte_user -d suporte_db -c "\dt"
```

---

## üìä Resultados Finais

### URLs Funcionando

| Ambiente | Tipo | URL | Status |
|----------|------|-----|--------|
| **Desenvolvimento** | Direto | `http://10.0.20.11:8002/api/v1/*` | ‚úÖ |
| **Desenvolvimento** | Docs | `http://10.0.20.11:8002/docs` | ‚úÖ |
| **Produ√ß√£o** | HTTP | `http://office.inoveon.com.br/api/suporte/v1/*` | ‚úÖ |
| **Produ√ß√£o** | HTTPS | `https://office.inoveon.com.br/api/suporte/v1/*` | ‚úÖ |
| **Produ√ß√£o** | Docs | `https://office.inoveon.com.br/api/suporte/docs` | ‚úÖ |

### Transforma√ß√£o de Paths (Testada e Validada)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CLIENTE                                                         ‚îÇ
‚îÇ POST https://office.inoveon.com.br/api/suporte/v1/auth/login  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TRAEFIK - StripPrefix Middleware                                ‚îÇ
‚îÇ Remove: /api/suporte                                            ‚îÇ
‚îÇ Resultado: /v1/auth/login                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TRAEFIK - AddPrefix Middleware                                  ‚îÇ
‚îÇ Adiciona: /api                                                  ‚îÇ
‚îÇ Resultado: /api/v1/auth/login                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASTAPI - Container (172.21.0.3:8002)                          ‚îÇ
‚îÇ Rota: @router.post("/v1/auth/login")                           ‚îÇ
‚îÇ Recebe: POST /api/v1/auth/login                                 ‚îÇ
‚îÇ ‚úÖ Match! ‚Üí Executa ‚Üí Retorna Token JWT                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### M√©tricas de Performance

- **Tempo de resposta m√©dio (direto):** ~50ms
- **Tempo de resposta m√©dio (via proxy):** ~80ms
- **Overhead do Traefik:** ~30ms
- **Health check interval:** 30s
- **SSL/TLS:** Let's Encrypt autom√°tico

---

## üéì Principais Aprendizados

### 1. Docker Compose

- ‚úÖ `docker-compose up -d` ‚Üí Recria e recarrega .env
- ‚ùå `docker restart` ‚Üí N√ÉO recarrega .env
- ‚úÖ Sempre usar `--no-cache` ao corrigir Dockerfiles

### 2. Traefik

- ‚úÖ **SEMPRE** definir `traefik.docker.network` se container em m√∫ltiplas redes
- ‚úÖ Middleware chain: ordem importa (`strip` ‚Üí `add`)
- ‚úÖ Health check path √© AP√ìS transforma√ß√£o de middlewares
- ‚úÖ Reiniciar Traefik ap√≥s mudan√ßas: `docker restart traefik`

### 3. FastAPI

- ‚úÖ `root_path` ‚Üí Muda paths reais (evitar!)
- ‚úÖ `servers` ‚Üí Apenas documenta√ß√£o (usar este)
- ‚úÖ SQLAlchemy 2.0+ ‚Üí Sempre usar `text()` para SQL textual
- ‚úÖ TrustedHostMiddleware ‚Üí Incluir IPs Docker ou desabilitar

### 4. Database

- ‚úÖ Usar mesma senha em `DATABASE_URL` e `DATABASE_URL_ASYNC`
- ‚úÖ Preferir IP do host ao nome do container
- ‚úÖ Migrations ‚â† Seed ‚Üí Criar scripts separados
- ‚úÖ Testar conex√£o antes de aplicar migrations

### 5. Debugging

- ‚úÖ Verificar logs: `docker logs -f container`
- ‚úÖ Verificar redes: `docker inspect container | grep IPAddress`
- ‚úÖ Verificar Traefik API: `curl http://HOST:8080/api/http/services`
- ‚úÖ Testar de dentro do container: `docker exec container curl localhost:PORT`

---

## üìö Documentos Relacionados

- [Guia Completo de Deploy H√≠brido](./DEPLOY-HIBRIDO-GUIA-COMPLETO.md)
- [Guia de Implementa√ß√£o Passo a Passo](./GUIA-IMPLEMENTACAO-PASSO-A-PASSO.md)
- [Templates de Configura√ß√£o](./TEMPLATES-CONFIGURACAO.md)
- [Estrat√©gia de Portas](./PORTAS-ESTRATEGIA.md)

---

## üë• Cr√©ditos

**Implementa√ß√£o:** Lee Chardes com assist√™ncia de Claude Code
**Data:** 16 de Outubro de 2025
**Tempo total de implementa√ß√£o:** ~4 horas (incluindo troubleshooting)
**Commits:** 7 corre√ß√µes aplicadas

---

**√öltima atualiza√ß√£o:** 16/10/2025 07:45 GMT
**Status:** ‚úÖ Produ√ß√£o - Funcionando perfeitamente
